name: Frontend Application

on:
  push:
    paths:
      - "**"
      - "!k8s/**"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "**"
      - "!k8s/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

permissions:
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY_FRONTEND }}

  DOCKER_PLATFORM: linux/amd64

jobs:
  app-ci:
    name: App CI (build + scans)
    runs-on: ubuntu-latest

    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Dependency vulnerability scan (npm audit)
        run: |
          # Non-zero exit should fail CI.
          npm audit --audit-level=high

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tag
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build image (local)
        run: |
          set -euo pipefail
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${{ steps.meta.outputs.tag }}"
          docker buildx build \
            --platform "${DOCKER_PLATFORM}" \
            -t "${IMAGE_URI}" \
            --load \
            .

      - name: Image vulnerability scan (Trivy)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.tag }}"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  app-cd:
    name: App CD (push image + trigger deploy)
    runs-on: ubuntu-latest
    needs: app-ci

    strategy:
      fail-fast: false
      matrix:
        # For now we only deploy staging. In the future, add: [dev, prod]
        env: [staging]

    env:
      ENV_NAME: ${{ matrix.env }}

    if: github.ref == 'refs/heads/main'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tag
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Select AWS role to assume (by environment)
        run: |
          set -euo pipefail
          case "${ENV_NAME}" in
            staging)
              echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN_APP_STAGING }}" >> "$GITHUB_ENV"
              ;;
            dev)
              echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN_APP_DEV }}" >> "$GITHUB_ENV"
              ;;
            prod)
              echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN_APP_PROD }}" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown ENV_NAME=${ENV_NAME}" >&2
              exit 1
              ;;
          esac

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}

      - name: Login to ECR
        run: |
          set -euo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" | \
            docker login --username AWS --password-stdin \
            "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - name: Build and push image
        run: |
          set -euo pipefail
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${{ steps.meta.outputs.tag }}"
          docker buildx build \
            --platform "${DOCKER_PLATFORM}" \
            -t "${IMAGE_URI}" \
            --push \
            .

      - name: Trigger deployment workflow (deploy repo)
        uses: actions/github-script@v7
        with:
          script: |
            core.info('TODO: call deployment repository workflow via workflow_dispatch or workflow_call.');
            core.info(`image_tag=${{ steps.meta.outputs.tag }}`);